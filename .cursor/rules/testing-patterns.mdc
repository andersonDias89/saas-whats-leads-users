# PadrÃµes de Teste - Cursor SaaS WhatsApp Leads

## ğŸ§ª Estrutura de Testes

### **LocalizaÃ§Ã£o dos Testes:**
- Testes em `__tests__/` seguindo a estrutura do `src/`
- Testes de schemas: `__tests__/schemas/[domain]/`
- Testes de hooks: `__tests__/hooks/[domain]/`
- Testes de componentes: `__tests__/components/[type]/`
- Testes de serviÃ§os: `__tests__/services/[domain]/`
- Testes de APIs: `__tests__/api/[domain]/`
- Testes de integraÃ§Ã£o: `__tests__/integration/`

### **ConfiguraÃ§Ã£o:**
- Jest configurado em [jest.config.js](mdc:jest.config.js)
- Setup global em [jest.setup.js](mdc:jest.setup.js)
- Mocks configurados para Next.js, Prisma, fetch, toast, socket.io

## ğŸ“ PadrÃµes de Nomenclatura

### **Arquivos de Teste:**
```typescript
// Nome do arquivo: feature.test.ts ou feature.test.tsx
describe('Feature', () => {
  describe('MÃ©todo ou Funcionalidade', () => {
    test('deve fazer algo especÃ­fico', () => {
      // teste
    })
  })
})
```

### **Testes de Schema (Zod):**
```typescript
describe('LeadSchema', () => {
  test('deve validar dados vÃ¡lidos', () => {
    const validData = { /* dados vÃ¡lidos */ }
    const result = leadSchema.safeParse(validData)
    expect(result.success).toBe(true)
  })

  test('deve rejeitar dados invÃ¡lidos', () => {
    const invalidData = { /* dados invÃ¡lidos */ }
    const result = leadSchema.safeParse(invalidData)
    expect(result.success).toBe(false)
  })
})
```

### **Testes de Hooks:**
```typescript
describe('useLeads', () => {
  beforeEach(() => {
    jest.clearAllMocks()
    jest.spyOn(console, 'error').mockImplementation(() => {})
  })

  afterEach(() => {
    jest.restoreAllMocks()
  })

  test('deve carregar leads com sucesso', async () => {
    // mock fetch
    global.fetch = jest.fn(() =>
      Promise.resolve({
        ok: true,
        json: () => Promise.resolve([/* leads */])
      })
    )

    // render hook
    const { result } = renderHook(() => useLeads())
    
    // aguardar carregamento
    await waitFor(() => {
      expect(result.current.isLoading).toBe(false)
    })
  })
})
```

### **Testes de Componentes:**
```typescript
describe('Button', () => {
  test('deve renderizar corretamente', () => {
    render(<Button>Click me</Button>)
    expect(screen.getByRole('button')).toBeInTheDocument()
  })

  test('deve chamar onClick quando clicado', () => {
    const handleClick = jest.fn()
    render(<Button onClick={handleClick}>Click me</Button>)
    
    fireEvent.click(screen.getByRole('button'))
    expect(handleClick).toHaveBeenCalledTimes(1)
  })
})
```

## ğŸ”§ Mocks e Setup

### **Mocks Globais (jest.setup.js):**
- Next.js Router mockado
- Prisma Client mockado
- Fetch API mockado
- Toast notifications mockado
- Socket.io mockado

### **Mocks EspecÃ­ficos:**
```typescript
// Mock de funÃ§Ã£o
const mockFunction = jest.fn().mockReturnValue(result)

// Mock de mÃ³dulo
jest.mock('module-name', () => ({
  functionName: jest.fn()
}))

// Mock de API
global.fetch = jest.fn(() =>
  Promise.resolve({
    ok: true,
    json: () => Promise.resolve(data)
  })
)
```

## âœ… Assertions PadrÃ£o

### **ValidaÃ§Ã£o de Sucesso:**
```typescript
expect(result.success).toBe(true)
expect(data).toBeDefined()
expect(array).toHaveLength(expectedLength)
```

### **ValidaÃ§Ã£o de Erro:**
```typescript
expect(result.success).toBe(false)
expect(result.error).toBeDefined()
expect(error.message).toContain('expected message')
```

### **ValidaÃ§Ã£o de Chamadas:**
```typescript
expect(mockFunction).toHaveBeenCalledWith(expectedArgs)
expect(mockFunction).toHaveBeenCalledTimes(expectedCalls)
```

### **ValidaÃ§Ã£o de Estado:**
```typescript
expect(screen.getByText('Loading')).toBeInTheDocument()
expect(element).toHaveClass('expected-class')
```

## ğŸš¨ Troubleshooting

### **Problemas Comuns:**

#### **1. Warning de act():**
```typescript
import { act } from '@testing-library/react'

await act(async () => {
  // cÃ³digo que atualiza estado
})
```

#### **2. Erro de Timezone:**
```typescript
// Usar datas ISO com timezone
const date = new Date('2024-01-01T00:00:00.000Z')
```

#### **3. Console.error nos testes:**
```typescript
beforeEach(() => {
  jest.spyOn(console, 'error').mockImplementation(() => {})
})

afterEach(() => {
  jest.restoreAllMocks()
})
```

## ğŸ“Š Cobertura Atual

### **Implementado:**
- âœ… Schemas (100%)
- âœ… Hooks (90%)
- âœ… Components (80%)
- âœ… Utils (100%)
- âœ… Integration (85%)

### **Pendente:**
- â³ Services (problemas de mock do Prisma)
- â³ APIs (problemas de resoluÃ§Ã£o de mÃ³dulos)
- â³ Webhooks
- â³ E2E tests

## ğŸ¯ Comandos Ãšteis

```bash
npm test                    # Executar todos os testes
npm run test:watch         # Executar com watch
npm test -- --coverage     # Verificar cobertura
npm test -- path/to/test   # Executar teste especÃ­fico
```

## ğŸ“š DocumentaÃ§Ã£o

- [EstratÃ©gia de Testes](mdc:docs/testing-strategy.md) - DocumentaÃ§Ã£o completa
- [Arquitetura](mdc:docs/architecture.md) - VisÃ£o geral do projeto
- [Melhores PrÃ¡ticas](mdc:docs/best-practices.md) - PadrÃµes gerais
description:
globs:
alwaysApply: false
---
