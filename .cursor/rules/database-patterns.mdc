# PadrÃµes de Banco de Dados - Cursor SaaS WhatsApp Leads

## ðŸ—„ï¸ Status em PortuguÃªs

### âœ… Correto:
```typescript
// Frontend
const statusOptions = [
  { value: 'novo', label: 'Novo' },
  { value: 'qualificado', label: 'Qualificado' },
  { value: 'nao_interessado', label: 'NÃ£o Interessado' },
  { value: 'fechado', label: 'Fechado' }
]

// Backend (Prisma)
model Lead {
  status String @default("novo")
}
```

### âŒ Evitar:
```typescript
// Misturar idiomas
{ value: 'new', label: 'Novo' }
{ value: 'contacted', label: 'Contactado' }
```

## ðŸ”— Relacionamentos

### âœ… Correto:
```typescript
// Sempre incluir relacionamentos necessÃ¡rios
const lead = await prisma.lead.findFirst({
  where: { id },
  include: {
    conversation: true,
    user: true
  }
})
```

## ðŸ“± Webhook e Leads

### âœ… CriaÃ§Ã£o de Lead via Webhook:
```typescript
// Criar ou atualizar lead
let lead = await prisma.lead.findFirst({
  where: {
    userId: user.id,
    phone: from
  }
})

if (!lead) {
  lead = await prisma.lead.create({
    data: {
      userId: user.id,
      conversationId: conversation.id,
      name: profileName || waId || from,
      phone: from,
      status: 'novo', // SEMPRE em portuguÃªs
      source: 'whatsapp'
    }
  })
}
```

## âœï¸ CriaÃ§Ã£o Manual de Leads

### âœ… CriaÃ§Ã£o Manual:
```typescript
// Criar lead manualmente
const lead = await prisma.lead.create({
  data: {
    userId: user.id,
    name: data.name,
    phone: data.phone,
    email: data.email || null,
    status: data.status,
    notes: data.notes || null,
    source: 'manual' // Sempre 'manual' para cadastros manuais
    // conversationId: null (leads manuais nÃ£o tÃªm conversa)
  },
  include: {
    conversation: true,
    user: {
      select: {
        id: true,
        name: true,
        email: true
      }
    }
  }
})
```

### âœ… ValidaÃ§Ã£o de Telefone Ãšnico:
```typescript
// Verificar se jÃ¡ existe lead com o mesmo telefone
const existingLead = await prisma.lead.findFirst({
  where: {
    userId: user.id,
    phone: data.phone
  }
})

if (existingLead) {
  throw new Error('JÃ¡ existe um lead com este telefone')
}
```

## ðŸ“Š Modelo de Dados Atualizado

### âœ… Schema do Lead:
```prisma
model Lead {
  id             String   @id @default(cuid())
  userId         String
  conversationId String?  // Opcional - leads manuais nÃ£o tÃªm conversa
  name           String?
  phone          String
  email          String?
  status         String   @default("novo") // novo, qualificado, nao_interessado, fechado
  source         String   @default("whatsapp") // whatsapp, manual
  notes          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversation Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([status])
}
```

## ðŸ”„ Regras de NegÃ³cio

### âœ… Origem dos Leads:
- **`source: 'whatsapp'`**: Leads criados via webhook do WhatsApp
- **`source: 'manual'`**: Leads cadastrados manualmente pelo usuÃ¡rio
- **Conversa opcional**: Leads manuais nÃ£o tÃªm `conversationId`

### âœ… ValidaÃ§Ãµes:
- **Telefone Ãºnico**: NÃ£o pode existir dois leads com o mesmo telefone para o mesmo usuÃ¡rio
- **Nome obrigatÃ³rio**: Para criaÃ§Ã£o manual, nome Ã© obrigatÃ³rio
- **Email opcional**: Pode ser vazio ou nulo
- **Status em portuguÃªs**: Sempre usar valores em portuguÃªs

### âœ… OperaÃ§Ãµes CRUD:
```typescript
// Buscar leads do usuÃ¡rio
const leads = await prisma.lead.findMany({
  where: { userId },
  include: { conversation: true },
  orderBy: { createdAt: 'desc' }
})

// Criar lead manual
const lead = await prisma.lead.create({
  data: { /* dados validados */ },
  include: { conversation: true }
})

// Atualizar lead
const updatedLead = await prisma.lead.update({
  where: { id: leadId },
  data: { /* dados de atualizaÃ§Ã£o */ },
  include: { conversation: true }
})

// Deletar lead (com conversa se existir)
await prisma.$transaction(async (tx) => {
  if (lead.conversation) {
    await tx.message.deleteMany({
      where: { conversationId: lead.conversation.id }
    })
    await tx.conversation.delete({
      where: { id: lead.conversation.id }
    })
  }
  await tx.lead.delete({ where: { id: leadId } })
})
```

## ðŸš¨ Regras Importantes
- **Status sempre em portuguÃªs** (`'novo'`, `'qualificado'`, `'nao_interessado'`, `'fechado'`)
- **Source obrigatÃ³rio** (`'whatsapp'` ou `'manual'`)
- **Conversa opcional** para leads manuais
- **Telefone Ãºnico** por usuÃ¡rio
- **Incluir relacionamentos** quando necessÃ¡rio
- **Usar default values** do Prisma schema
- **Validar dados** antes de salvar

## ðŸ“š ReferÃªncias
- [prisma/schema.prisma](mdc:prisma/schema.prisma) - Schema do banco
- [docs/best-practices.md](mdc:docs/best-practices.md) - PadrÃµes gerais
- [docs/architecture.md](mdc:docs/architecture.md) - Arquitetura detalhada

- [prisma/schema.prisma](mdc:prisma/schema.prisma) - Schema do banco
- [docs/best-practices.md](mdc:docs/best-practices.md) - PadrÃµes gerais
